<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¾ä»£åŒ–å‡ºé¡Œç³»çµ± Pro (Max)</title>
  <link rel="icon" href="https://925d84add0.cbaul-cdnwnd.com/19668665250194444779584b14efba7a/200000037-1fde21fde4/accessoriestexteditor_94073.ico?ph=925d84add0">
  <style>
    :root {
      --primary: #4f46e5;
      --primary-hover: #4338ca;
      --bg-color: #f3f4f6;
      --card-bg: #ffffff;
      --text-color: #1f2937;
      --text-secondary: #6b7280;
      --danger: #ef4444;
      --success: #10b981;
      --border-color: #e5e7eb;
      --radius: 12px;
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --font-base: 16px;
    }

    [data-theme="dark"] {
      --primary: #818cf8;
      --primary-hover: #6366f1;
      --bg-color: #111827;
      --card-bg: #1f2937;
      --text-color: #f3f4f6;
      --text-secondary: #9ca3af;
      --border-color: #374151;
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; transition: background-color 0.2s, color 0.2s, border-color 0.2s; }
    
    body { background: var(--bg-color); color: var(--text-color); height: 100vh; overflow: hidden; font-size: var(--font-base); }

    /* Icons */
    .icon { width: 20px; height: 20px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    
    /* Buttons */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      padding: 10px 20px; border-radius: 8px; font-weight: 500; cursor: pointer; border: none; outline: none; font-size: 0.95rem;
      transition: all 0.2s; user-select: none;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-outline { background: transparent; border: 2px solid var(--border-color); color: var(--text-color); }
    .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
    .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
    .btn-danger:hover { background: var(--danger); color: white; }
    .btn-ghost { background: transparent; color: var(--text-secondary); padding: 8px; }
    .btn-ghost:hover { background: rgba(0,0,0,0.05); color: var(--text-color); }
    
    .btn-load-option {
      display: grid; grid-template-columns: 50px 1fr; align-items: center; text-align: left; padding: 20px; width: 100%;
      background: var(--bg-color); border: 2px solid transparent; border-radius: 12px; color: var(--text-color); transition: all 0.2s; cursor: pointer;
    }
    .btn-load-option:hover { border-color: var(--primary); background: var(--card-bg); box-shadow: var(--shadow); }
    .btn-load-option .icon-box { display: flex; justify-content: center; align-items: center; width: 40px; height: 40px; background: rgba(79, 70, 229, 0.1); border-radius: 50%; color: var(--primary); }

    /* Layout */
    .view { display: none; height: 100%; flex-direction: column; }
    .view.active { display: flex; animation: fadeIn 0.3s ease-out; }

    #home-view { justify-content: center; align-items: center; }
    .hero-card { background: var(--card-bg); padding: 60px; border-radius: 24px; box-shadow: var(--shadow); text-align: center; max-width: 480px; width: 90%; }
    .hero-title { font-size: 2rem; margin-bottom: 40px; color: var(--primary); display: flex; align-items: center; justify-content: center; gap: 15px; }
    .home-actions { display: grid; gap: 15px; }

    .editor-header { height: 70px; background: var(--card-bg); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; padding: 0 24px; z-index: 10; }
    .title-input { font-size: 1.2rem; font-weight: bold; border: none; background: transparent; color: var(--text-color); border-bottom: 2px solid transparent; padding: 5px; width: 300px; text-align: center; }
    .title-input:focus { border-bottom-color: var(--primary); outline: none; }

    .editor-body { flex: 1; display: flex; overflow: hidden; }
    .sidebar { width: 300px; background: var(--card-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; }
    .sidebar-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
    
    .q-list { flex: 1; overflow-y: auto; padding: 10px; }
    .q-item { 
      padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: grab; border: 1px solid transparent; 
      display: flex; justify-content: space-between; align-items: center; background: var(--bg-color); user-select: none;
    }
    .q-item:active { cursor: grabbing; }
    .q-item.active { background: rgba(79, 70, 229, 0.1); border-color: var(--primary); color: var(--primary); }
    .q-item.dragging { opacity: 0.5; border: 2px dashed var(--primary); }
    .q-preview { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; font-size: 0.9rem; pointer-events: none; }

    .sidebar-footer { padding: 20px; border-top: 1px solid var(--border-color); background: var(--card-bg); }
    .adv-setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 0.9rem; }
    .adv-input { width: 70px; padding: 4px; border: 1px solid var(--border-color); border-radius: 4px; text-align: center; background: var(--bg-color); color: var(--text-color); }
    
    .main-area { flex: 1; padding: 40px; overflow-y: auto; background: var(--bg-color); }
    .editor-card { max-width: 800px; margin: 0 auto; background: var(--card-bg); padding: 40px; border-radius: 16px; box-shadow: var(--shadow); }

    .form-group { margin-bottom: 24px; }
    .label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: var(--text-secondary); }
    .input-field { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-color); font-size: 1rem; }
    .input-field:focus { border-color: var(--primary); outline: none; }

    .option-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; transition: transform 0.2s; background: var(--card-bg); }
    .option-row.dragging { opacity: 0.4; }
    .drag-handle { cursor: grab; color: var(--text-secondary); padding: 5px; display: flex; align-items: center; }
    .drag-handle:active { cursor: grabbing; color: var(--primary); }
    .radio-custom { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); }

    .fab { position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px; background: var(--card-bg); border-radius: 50%; box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-color); z-index: 50; }
    .fab:hover { transform: rotate(90deg); color: var(--primary); }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 100; opacity: 0; transition: opacity 0.3s; }
    .modal-overlay.open { display: flex; opacity: 1; }
    .modal-content { background: var(--card-bg); width: 90%; max-width: 500px; padding: 30px; border-radius: 20px; box-shadow: var(--shadow); transform: translateY(20px); transition: transform 0.3s; }
    .modal-overlay.open .modal-content { transform: translateY(0); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    
    .storage-list { max-height: 300px; overflow-y: auto; margin-top: 10px; border: 1px solid var(--border-color); border-radius: 8px; }
    .storage-item { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
    .storage-item:hover { background: var(--bg-color); }
    .storage-info { display: flex; flex-direction: column; gap: 4px; cursor: pointer; flex: 1; }

    /* Custom Context Menu */
    .context-menu {
      position: absolute;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow);
      border-radius: 8px;
      padding: 6px 0;
      width: 200px;
      z-index: 9999;
      display: none;
      flex-direction: column;
      font-size: 0.95rem;
    }
    .menu-item {
      padding: 10px 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--text-color);
      transition: background 0.1s;
    }
    .menu-item:hover { background: var(--bg-color); }
    .menu-item.disabled { color: var(--text-secondary); opacity: 0.5; cursor: default; pointer-events: none; }
    .menu-item .shortcut { font-size: 0.8rem; color: var(--text-secondary); }
    .menu-divider { height: 1px; background: var(--border-color); margin: 6px 0; }

    @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
    .hidden { display: none !important; }
    .d-flex { display: flex; gap: 10px; }
  </style>
</head>
<body oncontextmenu="return false"> <svg style="display: none;">
    <symbol id="icon-plus" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></symbol>
    <symbol id="icon-folder" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></symbol>
    <symbol id="icon-save" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></symbol>
    <symbol id="icon-upload" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></symbol>
    <symbol id="icon-trash" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></symbol>
    <symbol id="icon-back" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></symbol>
    <symbol id="icon-edit" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></symbol>
    <symbol id="icon-db" viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></symbol>
    <symbol id="icon-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></symbol>
    <symbol id="icon-moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></symbol>
    <symbol id="icon-drag" viewBox="0 0 24 24"><circle cx="9" cy="5" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="19" r="1"/></symbol>
  </svg>

  <div id="home-view" class="view active">
    <div class="hero-card">
      <h1 class="hero-title"><svg class="icon" style="width:40px;height:40px;"><use href="#icon-edit"/></svg> å‡ºé¡Œç³»çµ± Pro</h1>
      <div class="home-actions">
        <button class="btn btn-primary" onclick="createNewExam()"><svg class="icon"><use href="#icon-plus"/></svg> å‰µå»ºæ–°é¡Œç›®</button>
        <button class="btn btn-outline" onclick="openLoadModal()"><svg class="icon"><use href="#icon-folder"/></svg> é–‹å•ŸèˆŠæª”</button>
      </div>
    </div>
  </div>

  <div id="editor-view" class="view">
    <header class="editor-header">
      <div class="d-flex" style="align-items:center;">
        <button class="btn btn-ghost" onclick="goHome()"><svg class="icon"><use href="#icon-back"/></svg></button>
        <input type="text" id="exam-title" class="title-input" placeholder="è©¦å·åç¨±" onchange="saveCurrentQ()">
      </div>
      <div class="d-flex">
        <button class="btn btn-primary" style="background:var(--success);" onclick="saveToLocalStorage(true)"><svg class="icon"><use href="#icon-save"/></svg> å„²å­˜é€²åº¦</button>
        <button class="btn btn-primary" onclick="exportExam()"><svg class="icon"><use href="#icon-upload"/></svg> åŒ¯å‡ºè©¦å·</button>
      </div>
    </header>

    <div class="editor-body">
      <aside class="sidebar">
        <div class="sidebar-header">
          <span>é¡Œç›®åˆ—è¡¨ (å¯æ‹–æ›³)</span>
          <button class="btn btn-ghost" onclick="addQuestion()"><svg class="icon"><use href="#icon-plus"/></svg></button>
        </div>
        <div id="question-list" class="q-list"></div>
        <div class="sidebar-footer">
          <h4 style="margin-bottom:15px; font-size:0.9rem; color:var(--text-secondary);">é€²éšè¨­å®š (åŒ¯å‡ºæ™‚å¥—ç”¨)</h4>
          <div class="adv-setting-row">
            <label for="set-time">è€ƒè©¦æ™‚é–“ (åˆ†é˜)</label>
            <input type="number" id="set-time" class="adv-input" min="1" value="30" onchange="updateExamSettings()">
          </div>
          <div class="adv-setting-row">
            <label for="set-cheat">è¦–çª—é˜²ä½œå¼Šåµæ¸¬</label>
            <input type="checkbox" id="set-cheat" checked onchange="updateExamSettings()">
          </div>
        </div>
      </aside>
      <main class="main-area">
        <div class="editor-card">
          <div class="form-group">
            <label class="label">é¡Œç›®å…§å®¹</label>
            <textarea id="q-text" class="input-field" rows="3" placeholder="è¼¸å…¥é¡Œç›®æ•˜è¿°..."></textarea>
          </div>
          <div class="form-group">
            <label class="label">å¤šåª’é«”è³‡æº (é¸å¡«)</label>
            <div class="d-flex">
              <select id="q-media-type" class="input-field" style="width: 140px;">
                <option value="">ç„¡</option>
                <option value="image">åœ–ç‰‡ URL</option>
                <option value="audio">éŸ³è¨Š URL</option>
                <option value="video">å½±ç‰‡ URL</option>
              </select>
              <input type="text" id="q-media-src" class="input-field" placeholder="https://...">
            </div>
          </div>
          <div class="form-group">
            <label class="label">é¸é … (æ‹–æ›³å¯æ’åºï¼Œé»æ“Šåœ“éˆ•è¨­ç‚ºæ­£è§£)</label>
            <div id="options-container"></div>
            <button class="btn btn-outline" style="width:100%; margin-top:10px;" onclick="addOption()"><svg class="icon"><use href="#icon-plus"/></svg> æ–°å¢é¸é …</button>
          </div>
          <div style="text-align: right; margin-top: 30px;">
            <button class="btn btn-danger" onclick="deleteQuestion()"><svg class="icon"><use href="#icon-trash"/></svg> åˆªé™¤æœ¬é¡Œ</button>
          </div>
        </div>
      </main>
    </div>
  </div>

  <div id="custom-context-menu" class="context-menu">
    <div class="menu-item" id="cm-cut" onclick="execCmd('cut')">âœ‚ï¸ å‰ªä¸‹ <span class="shortcut">Ctrl+X</span></div>
    <div class="menu-item" id="cm-copy" onclick="execCmd('copy')">ğŸ“„ è¤‡è£½ <span class="shortcut">Ctrl+C</span></div>
    <div class="menu-item" id="cm-paste" onclick="execCmd('paste')">ğŸ“‹ è²¼ä¸Š <span class="shortcut">Ctrl+V</span></div>
    <div class="menu-divider"></div>
    <div class="menu-item" id="cm-select-all" onclick="execCmd('selectAll')">â–£ é¸å–å…¨éƒ¨ <span class="shortcut">Ctrl+A</span></div>
  </div>

  <div class="fab" onclick="openSettingsModal()"><svg class="icon" style="width:28px;height:28px;"><use href="#icon-settings"/></svg></div>

  <div id="load-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header"><h2>é–‹å•ŸèˆŠæª”</h2><button class="btn btn-ghost" onclick="closeModal('load-modal')">âœ•</button></div>
      <div class="d-flex" style="flex-direction: column; gap: 15px;">
        <button class="btn-load-option" onclick="triggerFileInput()">
          <div class="icon-box"><svg class="icon"><use href="#icon-folder"/></svg></div>
          <div><div style="font-weight:bold;">å¾æœ¬æ©Ÿæª”æ¡ˆ</div><div style="font-size:0.8rem;color:var(--text-secondary);">é¸æ“‡ .json æ ¼å¼</div></div>
        </button>
        <input type="file" id="file-input" accept=".json" class="hidden" onchange="handleFileSelect(event)">
        <button class="btn-load-option" onclick="showBrowserStorageList()">
          <div class="icon-box"><svg class="icon"><use href="#icon-db"/></svg></div>
          <div><div style="font-weight:bold;">å¾ç€è¦½å™¨æš«å­˜</div><div style="font-size:0.8rem;color:var(--text-secondary);">é¸æ“‡ä¹‹å‰å„²å­˜éçš„è©¦å·</div></div>
        </button>
      </div>
      <div id="load-storage-area" class="hidden" style="margin-top: 20px;">
        <div class="label">é¸æ“‡æš«å­˜è©¦å·ï¼š</div><div id="load-list-container" class="storage-list"></div>
      </div>
    </div>
  </div>

  <div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header"><h2>ç³»çµ±è¨­å®š</h2><button class="btn btn-ghost" onclick="closeModal('settings-modal')">âœ•</button></div>
      <div class="form-group" style="display:flex; justify-content:space-between;"><span>é¡è‰²ä¸»é¡Œ</span><button class="btn btn-outline" id="theme-btn" onclick="toggleTheme()"><svg class="icon"><use href="#icon-sun"/></svg> åˆ‡æ›</button></div>
      <div class="form-group" style="display:flex; justify-content:space-between;"><span>å­—é«”å¤§å°</span><input type="range" min="14" max="20" value="16" oninput="setFontSize(this.value)"></div>
      <hr style="margin:20px 0; border:0; border-top:1px solid var(--border-color);">
      <div class="form-group"><label class="label"><svg class="icon" style="vertical-align:bottom;"><use href="#icon-db"/></svg> æš«å­˜è³‡æ–™ç®¡ç†</label><div id="settings-storage-list" class="storage-list"></div></div>
    </div>
  </div>

  <script>
    const DB_KEY = 'EXAM_CREATOR_DB';
    let currentExam = { id: null, title: "æœªå‘½åè©¦å·", questions: [], settings: { timeLimit: 30, antiCheat: true }, lastModified: Date.now() };
    let currentQIndex = -1;
    let lastSavedState = "";
    let dragSrcEl = null;

    document.addEventListener('DOMContentLoaded', loadSettings);

    // --- Context Menu Logic ---
    const contextMenu = document.getElementById('custom-context-menu');
    let targetEl = null;

    document.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      targetEl = e.target;
      const isInput = targetEl.tagName === 'INPUT' || targetEl.tagName === 'TEXTAREA';
      const selectedText = window.getSelection().toString();
      const hasSelection = selectedText.length > 0 || (isInput && targetEl.value && (targetEl.selectionEnd - targetEl.selectionStart > 0));

      // Cut: Enabled if input AND has selection
      toggleMenu('cm-cut', isInput && hasSelection);
      // Copy: Enabled if has selection
      toggleMenu('cm-copy', hasSelection);
      // Paste: Enabled only if input (Browser security prevents checking clipboard content freely)
      toggleMenu('cm-paste', isInput);
      // Select All: Enabled if input OR content present
      toggleMenu('cm-select-all', isInput || document.body.innerText.length > 0);

      // å¦‚æœå…¨éƒ¨éƒ½åœç”¨ï¼Œä¸”ä¸åœ¨ Input å…§ï¼Œå¯èƒ½å°±ä¸é¡¯ç¤ºé¸å–®ï¼Œä½†é€™è£¡ç‚ºäº†å±•ç¤ºåŠŸèƒ½ï¼Œæˆ‘å€‘ç¸½æ˜¯é¡¯ç¤ºä½†è®Šç°
      contextMenu.style.display = 'flex';
      
      // Prevent menu going off screen
      let x = e.pageX;
      let y = e.pageY;
      if (x + 200 > window.innerWidth) x -= 200;
      contextMenu.style.left = x + 'px';
      contextMenu.style.top = y + 'px';
    });

    document.addEventListener('click', (e) => {
      if (!contextMenu.contains(e.target)) contextMenu.style.display = 'none';
    });

    function toggleMenu(id, enabled) {
      const el = document.getElementById(id);
      if (enabled) el.classList.remove('disabled'); else el.classList.add('disabled');
    }

    async function execCmd(cmd) {
      contextMenu.style.display = 'none';
      const isInput = targetEl && (targetEl.tagName === 'INPUT' || targetEl.tagName === 'TEXTAREA');

      if (cmd === 'paste') {
        if (!isInput) return;
        try {
          const text = await navigator.clipboard.readText();
          if (!text) return alert("å‰ªè²¼ç°¿æ˜¯ç©ºçš„ï¼");
          const start = targetEl.selectionStart;
          const end = targetEl.selectionEnd;
          const val = targetEl.value;
          targetEl.value = val.slice(0, start) + text + val.slice(end);
          targetEl.selectionStart = targetEl.selectionEnd = start + text.length;
          targetEl.dispatchEvent(new Event('input')); // Trigger save
          saveCurrentQ();
        } catch (err) {
          alert('ç„¡æ³•è®€å–å‰ªè²¼ç°¿ï¼Œè«‹ä½¿ç”¨ Ctrl+V è²¼ä¸Šã€‚\n(ç€è¦½å™¨å¯èƒ½å°é–äº†æ¬Šé™)');
        }
        return;
      }

      if (cmd === 'selectAll') {
        if (isInput) targetEl.select();
        else window.getSelection().selectAllChildren(document.body);
        return;
      }

      // Copy & Cut
      try {
        document.execCommand(cmd);
      } catch (e) {
        console.error(e);
      }
    }

    // --- App Logic ---
    function showView(id) { document.querySelectorAll('.view').forEach(e=>e.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function goHome() {
      saveCurrentQ(false);
      if (JSON.stringify(currentExam) !== lastSavedState && !confirm('âš ï¸ æœ‰æœªå„²å­˜çš„è®Šæ›´ï¼ç¢ºå®šé›¢é–‹å—ï¼Ÿ')) return;
      showView('home-view');
    }
    function updateLastSavedState() { lastSavedState = JSON.stringify(currentExam); }

    function createNewExam() {
      currentExam = { id: Date.now().toString(), title: "ç¬¬ä¸€æ¬¡ç·šä¸Šè€ƒè©¦", questions: [{ text: "ç¯„ä¾‹é¡Œç›®", options: ["é¸é …A", "é¸é …B"], correct: 0 }], settings: { timeLimit: 30, antiCheat: true }, lastModified: Date.now() };
      updateLastSavedState(); startEditor();
    }
    function startEditor() {
      document.getElementById('exam-title').value = currentExam.title;
      if(!currentExam.settings) currentExam.settings = { timeLimit: 30, antiCheat: true };
      document.getElementById('set-time').value = currentExam.settings.timeLimit;
      document.getElementById('set-cheat').checked = currentExam.settings.antiCheat;
      currentQIndex = 0; renderSidebar(); loadQuestionToEditor(); showView('editor-view');
    }
    function updateExamSettings() {
      currentExam.settings.timeLimit = parseInt(document.getElementById('set-time').value) || 30;
      currentExam.settings.antiCheat = document.getElementById('set-cheat').checked;
      saveToLocalStorage(false);
    }
    function saveCurrentQ(updateTimestamp = true) {
      if (currentQIndex === -1 || !currentExam.questions[currentQIndex]) return;
      const q = currentExam.questions[currentQIndex];
      q.text = document.getElementById('q-text').value;
      q.media = { type: document.getElementById('q-media-type').value, src: document.getElementById('q-media-src').value };
      if(!q.media.type) delete q.media;
      const optRows = Array.from(document.querySelectorAll('#options-container .option-row'));
      q.options = optRows.map(row => row.querySelector('.opt-text').value);
      const checkedRadio = document.querySelector('input[name="correct-ans"]:checked');
      q.correct = checkedRadio ? parseInt(checkedRadio.value) : 0;
      currentExam.title = document.getElementById('exam-title').value;
      if(updateTimestamp) currentExam.lastModified = Date.now();
      const item = document.querySelectorAll('.q-item')[currentQIndex];
      if(item) item.querySelector('.q-preview').textContent = `Q${currentQIndex+1}. ${q.text}`;
    }

    function renderSidebar() {
      const list = document.getElementById('question-list'); list.innerHTML = '';
      currentExam.questions.forEach((q, i) => {
        const div = document.createElement('div'); div.className = `q-item ${i === currentQIndex ? 'active' : ''}`;
        div.draggable = true; div.dataset.index = i;
        div.innerHTML = `<span class="q-preview">Q${i+1}. ${q.text || 'ç„¡æ¨™é¡Œ'}</span><svg class="icon" style="opacity:0.5;width:16px;"><use href="#icon-drag"/></svg>`;
        div.onclick = () => { saveCurrentQ(); currentQIndex = i; renderSidebar(); loadQuestionToEditor(); };
        div.addEventListener('dragstart', function(e){dragSrcEl=this;e.dataTransfer.effectAllowed='move';this.classList.add('dragging');});
        div.addEventListener('dragover', function(e){if(e.preventDefault)e.preventDefault();e.dataTransfer.dropEffect='move';return false;});
        div.addEventListener('drop', function(e){
          e.stopPropagation();
          if(dragSrcEl!==this){
            const oldIndex=parseInt(dragSrcEl.dataset.index); const newIndex=parseInt(this.dataset.index);
            const movedItem=currentExam.questions.splice(oldIndex,1)[0]; currentExam.questions.splice(newIndex,0,movedItem);
            if(currentQIndex===oldIndex)currentQIndex=newIndex;
            else if(currentQIndex>oldIndex&&currentQIndex<=newIndex)currentQIndex--;
            else if(currentQIndex<oldIndex&&currentQIndex>=newIndex)currentQIndex++;
            renderSidebar(); loadQuestionToEditor();
          } return false;
        });
        div.addEventListener('dragend', function(){this.classList.remove('dragging');});
        list.appendChild(div);
      });
    }

    function loadQuestionToEditor() {
      const q = currentExam.questions[currentQIndex];
      document.getElementById('q-text').value = q.text || '';
      document.getElementById('q-media-type').value = q.media ? q.media.type : '';
      document.getElementById('q-media-src').value = q.media ? q.media.src : '';
      const container = document.getElementById('options-container'); container.innerHTML = '';
      (q.options || []).forEach((opt, idx) => addOptionToDOM(opt, idx === q.correct));
    }

    function addOptionToDOM(text = '', isCorrect = false) {
      const container = document.getElementById('options-container');
      const div = document.createElement('div'); div.className = 'option-row'; div.draggable = true;
      div.innerHTML = `<div class="drag-handle"><svg class="icon"><use href="#icon-drag"/></svg></div><input type="radio" name="correct-ans" class="radio-custom" ${isCorrect ? 'checked' : ''}><input type="text" class="input-field opt-text" value="${text}" placeholder="é¸é …å…§å®¹" onchange="saveCurrentQ()"><button class="btn btn-ghost" style="color:var(--danger)" onclick="this.parentElement.remove();updateOptionRadios();saveCurrentQ();">âœ•</button>`;
      div.addEventListener('dragstart', function(e){dragSrcEl=this;e.dataTransfer.effectAllowed='move';this.classList.add('dragging');});
      div.addEventListener('dragover', function(e){if(e.preventDefault)e.preventDefault();e.dataTransfer.dropEffect='move';return false;});
      div.addEventListener('drop', function(e){e.stopPropagation();if(dragSrcEl!==this){const all=[...container.children];const srcIdx=all.indexOf(dragSrcEl);const targetIdx=all.indexOf(this);if(srcIdx<targetIdx)container.insertBefore(dragSrcEl,this.nextSibling);else container.insertBefore(dragSrcEl,this);updateOptionRadios();saveCurrentQ();}return false;});
      div.addEventListener('dragend', function(){this.classList.remove('dragging');});
      container.appendChild(div); updateOptionRadios();
    }
    function updateOptionRadios() { document.querySelectorAll('#options-container .option-row').forEach((row, idx) => { row.querySelector('input[type="radio"]').value = idx; }); }
    function addOption() { addOptionToDOM(); saveCurrentQ(); }
    function addQuestion() { saveCurrentQ(); currentExam.questions.push({ text: "æ–°é¡Œç›®", options: ["é¸é …1"], correct: 0 }); currentQIndex = currentExam.questions.length - 1; renderSidebar(); loadQuestionToEditor(); const list=document.querySelector('.q-list');list.scrollTop=list.scrollHeight; }
    function deleteQuestion() { if(currentExam.questions.length <= 1) return alert("è‡³å°‘ä¿ç•™ä¸€é¡Œ"); if(!confirm("ç¢ºå®šåˆªé™¤æ­¤é¡Œï¼Ÿ")) return; currentExam.questions.splice(currentQIndex, 1); currentQIndex = Math.max(0, currentQIndex - 1); renderSidebar(); loadQuestionToEditor(); }
    function getDB() { return JSON.parse(localStorage.getItem(DB_KEY) || '{}'); }
    function saveToLocalStorage(alertUser) { saveCurrentQ(); const db = getDB(); db[currentExam.id] = currentExam; localStorage.setItem(DB_KEY, JSON.stringify(db)); updateLastSavedState(); if(alertUser) alert(`âœ… "${currentExam.title}" å·²å„²å­˜ï¼`); }
    function deleteFromDB(id) { if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return; const db = getDB(); delete db[id]; localStorage.setItem(DB_KEY, JSON.stringify(db)); renderStorageList('settings-storage-list', true); renderStorageList('load-list-container', false); }
    function loadFromDB(id) { const db = getDB(); if (db[id]) { currentExam = db[id]; if(!currentExam.settings) currentExam.settings = { timeLimit: 30, antiCheat: true }; updateLastSavedState(); closeModal('load-modal'); startEditor(); } }
    function handleFileSelect(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { try { const json = JSON.parse(event.target.result); if (Array.isArray(json)) { currentExam = { id: Date.now().toString(), title: "åŒ¯å…¥", questions: json, settings:{timeLimit:30, antiCheat:true}, lastModified: Date.now() }; } else { currentExam = json; currentExam.id = Date.now().toString(); if(!currentExam.settings) currentExam.settings = { timeLimit: 30, antiCheat: true }; } updateLastSavedState(); closeModal('load-modal'); startEditor(); } catch (err) { alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤"); } }; reader.readAsText(file); e.target.value = ''; }
    function exportExam() { saveToLocalStorage(); const jsonStr = JSON.stringify(currentExam, null, 2); downloadFile(currentExam.title + ".json", jsonStr, 'application/json'); const htmlContent = generateHtml(currentExam); downloadFile(currentExam.title + ".html", htmlContent, 'text/html'); }
    function downloadFile(filename, content, type) { const blob = new Blob([content], { type: type }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url); }

    function generateHtml(examData) {
      const minutes = examData.settings.timeLimit || 30;
      const totalSeconds = minutes * 60;
      const timerText = `${minutes.toString().padStart(2,'0')}:00`;
      const antiCheatScript = examData.settings.antiCheat ? `
        blurCount = 0;
        window.addEventListener("blur", () => {
          blurCount++;
          if (blurCount === 1) showNotice("âš ï¸ è­¦å‘Šï¼åµæ¸¬åˆ°ä½ åˆ‡æ›è¦–çª—ï¼Œå†åˆ‡ä¸€æ¬¡å°‡è‡ªå‹•äº¤å·ï¼");
          else if (blurCount === 2) { showNotice("âŒ ç¬¬äºŒæ¬¡åˆ‡æ›è¦–çª—ï¼Œç³»çµ±è‡ªå‹•äº¤å·ã€‚"); showResults(true); }
        });` : '// é˜²ä½œå¼Šå·²é—œé–‰';

      return `<!DOCTYPE html><html lang="zh-Hant"><head><meta charset="UTF-8"><title>${examData.title}</title><meta name="viewport" content="width=device-width, initial-scale=1"><style>html,body{margin:0;padding:0;height:100%;font-family:"Segoe UI",sans-serif;background-color:#f7f7f7;overflow:hidden;user-select:none}header{position:fixed;top:0;left:0;right:0;height:60px;background:#fff;border-bottom:1px solid #ccc;display:flex;justify-content:space-between;align-items:center;padding:0 30px;box-shadow:0 2px 4px rgba(0,0,0,0.05);z-index:10}.timer{font-weight:bold;color:#d9534f;font-size:18px}.container{position:absolute;top:60px;left:0;right:0;bottom:0;display:flex;justify-content:center;align-items:center;padding:30px;box-sizing:border-box}#rules{max-width:700px;width:100%;background:white;padding:30px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,0.1);line-height:1.8}#start-btn{margin-top:20px;padding:12px 24px;font-size:16px;border:none;border-radius:5px;background:#28a745;color:white;cursor:pointer;width:100%}.question-box{background:white;padding:30px 30px 80px;border-radius:12px;width:100%;max-width:800px;box-shadow:0 8px 20px rgba(0,0,0,0.1);position:relative;overflow-y:auto;max-height:80vh}.answers label{display:block;margin:12px 0;font-size:18px;cursor:pointer}.button-group{position:fixed;bottom:20px;right:30px;display:flex;gap:10px;z-index:15}.btn{padding:10px 20px;font-size:16px;border:none;border-radius:6px;background:#007bff;color:white;cursor:pointer;min-width:120px}.hidden{display:none}#result{margin-top:30px;background:#e8f8e8;padding:20px;border-radius:10px;max-height:60vh;overflow-y:auto}@media(max-width:480px){.button-group{bottom:0;left:0;right:0;padding:10px;background:white;border-top:1px solid #eee}.btn{flex:1}.question-box{padding-bottom:80px}}</style></head><body oncontextmenu="return false" onkeydown="return false"><header><h1>${examData.title}</h1><div class="timer" id="timer">${timerText}</div></header><div class="container"><div id="rules"><h2>ğŸ“œ è€ƒè©¦è¦å‰‡</h2><ul><li>è€ƒè©¦æ™‚é–“ï¼š${minutes} åˆ†é˜ã€‚</li><li>å…±æœ‰ ${examData.questions.length} é¡Œï¼Œå–®é¸ã€‚</li><li>ç¦æ­¢é›¢é–‹è¦–çª—æˆ–åˆ‡æ›åˆ†é ${examData.settings.antiCheat?' (ç³»çµ±å°‡è‡ªå‹•åµæ¸¬)':''}ã€‚</li></ul><button id="start-btn">é–‹å§‹è€ƒè©¦</button></div><div class="question-box hidden" id="exam-box"><h2 id="question-text">è¼‰å…¥ä¸­...</h2><div class="answers" id="answer-options"></div><div class="button-group" id="navigation-buttons"><button id="prev-btn" class="btn">ä¸Šä¸€é¡Œ</button><button id="next-btn" class="btn">ä¸‹ä¸€é¡Œ</button><button id="finish-btn" class="btn hidden">äº¤å·</button></div><div id="result" class="hidden"></div></div></div><script>const questions=${JSON.stringify(examData.questions)};let current=0;const userAnswers=JSON.parse(localStorage.getItem("userAnswers")||"[]");let remainingSeconds=${totalSeconds};let interval;const els={qText:document.getElementById("question-text"),opts:document.getElementById("answer-options"),prev:document.getElementById("prev-btn"),next:document.getElementById("next-btn"),finish:document.getElementById("finish-btn"),res:document.getElementById("result"),timer:document.getElementById("timer"),rules:document.getElementById("rules"),box:document.getElementById("exam-box"),nav:document.getElementById("navigation-buttons")};function formatTime(sec){const m=Math.floor(sec/60).toString().padStart(2,"0");const s=(sec%60).toString().padStart(2,"0");return m+":"+s}function startTimer(){interval=setInterval(()=>{remainingSeconds--;els.timer.textContent=formatTime(remainingSeconds);if(remainingSeconds<=0){clearInterval(interval);showResults(true)}},1000)}function loadQuestion(){const q=questions[current];els.qText.innerHTML="Q"+(current+1)+". "+q.text;if(q.media){let mHtml="";if(q.media.type==="image")mHtml='<img src="'+q.media.src+'" style="max-width:100%;margin:10px 0;border-radius:8px;">';else if(q.media.type==="audio")mHtml='<audio controls style="width:100%"><source src="'+q.media.src+'"></audio>';else if(q.media.type==="video")mHtml='<video controls style="max-width:100%"><source src="'+q.media.src+'"></video>';els.qText.innerHTML+='<div>'+mHtml+'</div>'}els.opts.innerHTML="";q.options.forEach((opt,i)=>{const checked=userAnswers[current]===i?"checked":"";els.opts.innerHTML+='<label><input type="radio" name="ans" value="'+i+'" '+checked+'> '+opt+'</label>'});els.prev.disabled=current===0;if(current===questions.length-1){els.next.classList.add("hidden");els.finish.classList.remove("hidden")}else{els.next.classList.remove("hidden");els.finish.classList.add("hidden")}}function saveAns(){const sel=document.querySelector('input[name="ans"]:checked');if(sel){userAnswers[current]=parseInt(sel.value);localStorage.setItem("userAnswers",JSON.stringify(userAnswers))}}function showResults(force){saveAns();clearInterval(interval);els.nav.classList.add("hidden");els.timer.textContent="çµæŸ";if(!force){if(questions.some((_,i)=>userAnswers[i]===undefined)){if(!confirm("å°šæœ‰é¡Œç›®æœªä½œç­”ï¼Œç¢ºå®šäº¤å·ï¼Ÿ")){els.nav.classList.remove("hidden");startTimer();return}}}let score=0,output="";questions.forEach((q,i)=>{const u=userAnswers[i],c=q.correct,isC=u===c;if(isC)score++;output+="<div><strong>Q"+(i+1)+"</strong>: "+q.text+"<br>ä½ : "+(u!==undefined?q.options[u]:"æœªç­”")+" | æ­£è§£: "+q.options[c]+" <span style='color:"+(isC?"green":"red")+"'>"+(isC?"âœ”":"âœ˜")+"</span></div><br>"});els.res.innerHTML="<h3>å¾—åˆ†: "+score+" / "+questions.length+"</h3>"+output;els.res.classList.remove("hidden");els.box.scrollTop=0;els.qText.textContent="æ¸¬é©—çµæœ";els.opts.innerHTML="";localStorage.removeItem("userAnswers")}els.prev.onclick=()=>{saveAns();if(current>0)current--;loadQuestion()};els.next.onclick=()=>{saveAns();if(current<questions.length-1)current++;loadQuestion()};els.finish.onclick=()=>showResults();document.getElementById("start-btn").onclick=()=>{els.rules.classList.add("hidden");els.box.classList.remove("hidden");loadQuestion();startTimer();${antiCheatScript}};function showNotice(msg){const b=document.createElement("div");b.textContent=msg;Object.assign(b.style,{position:"fixed",top:"70px",left:"50%",transform:"translateX(-50%)",padding:"10px 20px",background:"#fff3cd",border:"1px solid #ffeeba",color:"#856404",zIndex:9999,borderRadius:"8px"});document.body.appendChild(b);setTimeout(()=>b.remove(),4000)}<\/script></body></html>`;
    }

    function openModal(id){document.getElementById(id).classList.add('open');}
    function closeModal(id){document.getElementById(id).classList.remove('open');}
    function openLoadModal(){ document.getElementById('load-storage-area').classList.add('hidden'); openModal('load-modal'); }
    function openSettingsModal(){ renderStorageList('settings-storage-list', true); openModal('settings-modal'); }
    function triggerFileInput(){document.getElementById('file-input').click();}
    function showBrowserStorageList(){ document.getElementById('load-storage-area').classList.remove('hidden'); renderStorageList('load-list-container', false); }
    function renderStorageList(cid, manage){
       const db=getDB(), c=document.getElementById(cid); c.innerHTML='';
       Object.keys(db).sort((a,b)=>db[b].lastModified-db[a].lastModified).forEach(id=>{
         const e=db[id], d=document.createElement('div'); d.className='storage-item';
         d.innerHTML=`<div class="storage-info" ${!manage?`onclick="loadFromDB('${id}')"`:''}><span style="font-weight:bold">${e.title}</span><span style="font-size:0.8rem;color:#888">${new Date(e.lastModified).toLocaleString()}</span></div>${manage?`<button class="btn btn-ghost" style="color:var(--danger)" onclick="deleteFromDB('${id}')"><svg class="icon"><use href="#icon-trash"/></svg></button>`:''}`;
         c.appendChild(d);
       });
       if(!c.firstChild) c.innerHTML='<div style="padding:20px;text-align:center;color:#888">ç„¡è³‡æ–™</div>';
    }
    function toggleTheme(){ const h=document.documentElement, n=h.getAttribute('data-theme')==='light'?'dark':'light'; h.setAttribute('data-theme',n); localStorage.setItem('theme',n); document.querySelector('#theme-btn use').setAttribute('href',n==='light'?'#icon-sun':'#icon-moon'); }
    function setFontSize(v){ document.documentElement.style.setProperty('--font-base',v+'px'); localStorage.setItem('fontSize',v); }
    function loadSettings(){
       const t=localStorage.getItem('theme')||'light', f=localStorage.getItem('fontSize');
       document.documentElement.setAttribute('data-theme',t); if(f)setFontSize(f);
       document.querySelector('#theme-btn use').setAttribute('href',t==='light'?'#icon-sun':'#icon-moon');
       if(document.querySelector('input[type=range]')) document.querySelector('input[type=range]').value=f||16;
    }
  </script>
</body>
</html>
